{% extends "project/base.html" %}
{% set page_title = _("Bake Progress Log") %}

{% block body %}

{% from 'project/macros.html' import nav with context%}
{{ nav('log') }}

<pre id="log"></pre>
{% endblock %}


{% block extrajs %}
<script type="text/javascript">
/* fast analog of python .startswith string type method function */
if (typeof String.prototype.startswith != 'function') {
  String.prototype.startswith = function (str){
    if (str === '') return true;
    if (this == null || str == null) return false;
    return this.length >= str.length && this.slice(0, str.length) === str;
  };
}

$(document).ready(function () {

var $log = $('#log');
var buildsocket = io.connect("/build", {'force new connection': true});

buildsocket.on("connect", function(e) {
  console.log("Connected", arguments);
  buildsocket.emit('subscribe', '{{ [project.login, project.id]|join('/')|signify }}');
});

buildsocket.on("disconnect", function(e) {
  console.log("Disconnected", arguments);
});

buildsocket.on('message', function (data) {
  var data = String(data);
  if (data == '1') { }
  else if (data.startswith('Header: ')){
    var h2 = $(document.createElement("h2"));
    $log.append($('<h4>').html(data.slice('Header: '.length)));
  } else if (data.startswith('Error: ')){
    $log.append($('<span>').addClass('text-error').html(data.slice('Error: '.length)));
  } else if (data.startswith('Fatal: ')){
    $log.append($('<span>').addClass('text-error').html('<span class="label label-important">Fatal</span> ' + data.slice('Fatal: '.length)));
  } else if (data.startswith('End: ')){
    $log.append($('<span>').addClass('text-success').html('<span class="label label-success">End</span> ' + data.slice('End: '.length)));
  } else if (data.startswith('Command: ')){
    $log.append($('<span>').addClass('text-info').html("$ " + data.slice('Command: '.length)));
  } else {
    $log.append($('<span>').html(data));
  }
  // scroll to the bottom of the page
  $(document).scrollTop($(document).height());
});

});
</script>
{% endblock %}
