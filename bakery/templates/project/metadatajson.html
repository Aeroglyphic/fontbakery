{% extends "project/base.html" %}
{% set page_title = _("Edit METADATA.json") %}

{% block pnav %}
{% from 'project/macros.html' import nav with context%}
{{ nav('build') }}
{% endblock %}

{% block pbody %}
{% from 'project/macros.html' import subnav_build with context%}
{{ subnav_build('metadatajson') }}

{% if metadata_new and metadata %}
<div class="col-md-6">
  <h4>{{ _("METADATA.json imported from upstream repo") }}</h4>
  <div class="container">
    <div class="row">
        <form class="form-horizontal" action="{{ url_for('project.metadatajson', project_id=project.id, build_id=build.id)}}" method="POST">
          <div class="col-sm-5 col-md-5">
              <div id="editor"></div>
              <textarea name="metadatajson" id="metadatajson">{{ metadata }}</textarea>
              <p style="padding-top:1em">
                <button type="submit" class="btn btn-primary">{{ _("Save") }}</button>
              </p>
          </div>
        </form>
    </div>
  </div>
</div>

<div class="col-md-6">
  <h4>{{ _("METADATA.json.new generated from files") }}</h4>
  <pre><code id="right">{{ metadata_new }}</code></pre>
  <!-- <div style="margin-bottom: 12px;">
    <a class="btn btn-danger">
      <span>{{ _('Delete <code>METADATA.json.new</code>') }}</span>
    </a>
  </div> -->
</div>

  <div id="delta-panel-visual" style="clear: both;">
      <p id="visualdiff"></p>
  </div>

{% elif not metadata %}
<div class="col-md-12">
  <h4 class="text-danger">{{ _("METADATA.json does not yet exist") }}</h4>
</div>
{% else %}
<div class="col-md-12">
  <h4>{{ _("METADATA.json generated from files") }}</h4>
        <form class="form-horizontal" action="{{ url_for('project.metadatajson', project_id=project.id, build_id=build.id)}}" method="POST">
          <div>
              <div id="editor"></div>
              <textarea name="metadatajson" id="metadatajson">{{ metadata }}</textarea>
              <p style="padding-top:1em">
                <button type="submit" class="btn btn-primary">{{ _("Save") }}</button>
              </p>
          </div>
        </form>
</div>
{% endif %}

{% endblock %}


{% block extrajs %}
{% if metadata_new and metadata %}
<script type="text/javascript" src="{{ url_for('static', filename='libs/jsondiffpatch/build/bundle.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='libs/jsondiffpatch/build/formatters.min.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='libs/jsondiffpatch/src/formatters/html.css') }}" type="text/css" />
{% endif %}
<script>
$(document).ready(function () {

  var editor = ace.edit("editor");
  editor.setTheme("ace/theme/solarized_light");
  editor.getSession().setMode("ace/mode/html");
  editor.getSession().setUseSoftTabs(false);
  editor.getSession().setUseWrapMode(true);
  editor.setHighlightActiveLine(false);

  var textarea = $('textarea[name="metadatajson"]').hide();
  editor.getSession().setUseWrapMode(true);
  editor.getSession().setValue(textarea.val());
  editor.getSession().on('change', function(){
    textarea.val(editor.getSession().getValue());
  });

  // From https://gist.github.com/hostilefork/6325151 & http://stackoverflow.com/questions/11584061/
  var heightUpdateFunction = function() {
      var newHeight =
                editor.getSession().getScreenLength()
                * editor.renderer.lineHeight
                + editor.renderer.scrollBar.getWidth();
      $('#editor').height(newHeight.toString() + "px");
      $('#editor-section').height(newHeight.toString() + "px");
      // This call is required for the editor to fix all of its inner structure for adapting to a change in size
      editor.resize();
  };

  heightUpdateFunction();

  {% if metadata_new and metadata_new %}
  var left = JSON.parse($('#left').text());
  var right = JSON.parse($('#right').text());

  var instance = jsondiffpatch.create({
        objectHash: function(obj) {
            return '';
        }
    });

  var delta = instance.diff(left, right);

  var visualdiff = document.getElementById('visualdiff');
  if (visualdiff) {
    visualdiff.innerHTML = jsondiffpatch.formatters.html.format(delta, left);

    var scripts = visualdiff.querySelectorAll('script');
    for (var i = 0; i < scripts.length; i++) {
        var s = scripts[i];
        /* jshint evil: true */
        eval(s.innerHTML);
    }
  }
  {% endif %}
});
</script>
{% endblock %}
