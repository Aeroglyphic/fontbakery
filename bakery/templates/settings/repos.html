{% extends "base.html" %}
{% set page_title = _("Add repositories") %}

{% block body %}
    <h2>{{ _("Add repositories") }}</h2>

<div class="tabbable">

  <ul class="nav nav-tabs">
    <li class="active"><a href="#owngit" data-toggle="tab">{{ _("URL") }}</a></li>
    <li><a href="#massgithub" data-toggle="tab">{{ _("GitHub: One Time") }}</a></li>
    <li><a href="#github" data-toggle="tab">{{ _("GitHub: Subscription") }}</a></li>
  </ul>

  <div class="tab-content">

    <div id="massgithub" class="tab-pane">
      <h4>{{ _("From GitHub") }}</h4>
      <form class="well well-small" action="{{ url_for('settings.update') }}" method="POST">
        {% if cache %}
          {{ _("List of GitHub repositories last updated") }} {{ cache.updated | pretty_date}}
          <button type="submit" class="btn btn btn-small pull-right">{{ _("Refresh") }}</button>
          {% else %}
          <button type="submit" class="btn btn-primary btn-small pull-right">{{ _("Refresh") }}</button>
        {% endif %}
      </form>

      <p>{{ _("Select repositories to add from your GitHub account") }}:</p>

        <form action="{{ url_for('settings.massgit') }}" method="POST">
          {% if cache %}
            {% for item in cache.data -%}
            <label class="checkbox" for="{{ item.full_name }}"><input id="{{ item.full_name }}" type="checkbox" {% if item.full_name in projects%}checked="checked"{%endif%} value="{{ item.full_name }}" name="git"> {{ item.full_name }}</label>
            {%- endfor %}
          {% else %}
            <p class="muted">{{ _("Click 'Refresh' to update this list.") }}</p>
          {% endif %}

          <button type="submit" class="btn" data-confirm="{{ _('Are you sure that each git repository contains fonts available under a libre license?') }}">{{ _("Add repos") }}</button>

          <div class="alert alert-info">
	          {{ _("Repositories are cloned, which can take a while and your browser may show a timeout. If this happens, check the dashboard to confirm the repo has been cloned.") }}
          </div>
          <p>TODO Pop up a dialog to confirm the repo has a libre license allowing you to copy it</p>
        </form>

    </div>

    <div id="github" class="tab-pane">
      <h4>From GitHub with Subscriptions</h4>
      <form class="well well-small" action="{{ url_for('settings.update') }}" method="POST">
        {% if cache %}
          List of GitHub repositories last updated {{ cache.updated | pretty_date}}
          <button type="submit" class="btn btn btn-small pull-right">Refresh</button>
          {% else %}
          <button type="submit" class="btn btn btn-primary pull-right">Refresh</button>
        {% endif %}
      </form>

      <p>To add repositories from GitHub with webhooks to get updates when a repo is updated, click a <a class="btn btn-mini"><i class="icon-star-empty"></i></a></p>

      <table class="table table-striped">
        <thead>
          <tr>
            <th><i class="icon-star-empty"></i></th>
            <th>Repository</th>
            <th>Description</th>
            <th>Settings</th>
          </tr>
        </thead>

        <tbody>
          {% if cache %}
            {% for item in cache.data -%}
              <tr {% if item.full_name in projects%} class="success" {% endif %}>
                <td>{% if item.full_name in projects %}<a href="{{ url_for('settings.delhook', full_name=item.full_name) }}"><i class="icon-star"></i></a>{% else %}<a href="{{ url_for('settings.addhook', full_name=item.full_name) }}" data-confirm="Are you confirm that this git repository contains font available under Open Source or Creative Commons licenses?"><i class="icon-star-empty"></i></a>{% endif %}</td>
                <td>{{ item.full_name }} {% if item.homepage %}<a href="{{ item.homepage}} "><i class="icon-share"></i></a>{% endif %}</td>
                <td>{% if item.description %}{{ item.description | truncate(length=80)}}{% endif %}</td>
                <td><a href="{{ item.html_url }}/settings/hooks"><i class="icon-wrench"></i></a></td>
              </tr>
            {%- endfor %}
          {% else %}
          <tr>
              <td colspan="4">
                  <p class="muted">Click 'Refresh' to update this list.</p>
              </td>
          </tr> 
          {% endif %}
        </tbody>
      </table>

    </div>


    <div id="owngit" class="tab-pane active">
    <h4>From URL</h4>

    <p>Enter a git clone string in the allowed format. If a login is required, provide it in the clone string <a href="https://www.kernel.org/pub/software/scm/git/docs/git-clone.html#URLS">(Learn more...)</a></p>

    <form class="form-inline" action="{{ url_for('settings.addclone') }}" method="POST">
      <label><code>$ git clone</code></label>
      <input type="text" class="input-xxlarge" name="clone" placeholder="git://[login:password@]domain.tld[:port]/path/to/repo.git">
      <button type="submit" class="btn btn-primary btn-small" data-confirm="Are you sure that this git repository contains fonts available under a libre license?">Add Repo</button>
    </form>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Repository URLs</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody>
        {% if gitprojects %}
          {% for item in gitprojects -%}
            <tr>
              <td><code>{{ item.clone }}</code></td>
			  <td><a href="{{ url_for('settings.delclone', project_id=item.id) }}"><button class="btn btn-mini btn-danger btn-block" type="button" data-confirm="Delete this repo?">Delete</button></a></td>
            </tr>
          {%- endfor %}
        {% else %}
        <tr>
            <td colspan="2">
                <p class="muted">Add a git repository by URL</p>
            </td>
        </tr> 
        {% endif %}
      </tbody>
    </table>
    </div>

  </div><!-- /.tab-content -->
</div><!-- /.tabbable -->
{% endblock %}

{% block extrajs %}
<script type="text/javascript">
// Javascript to enable link to tab
var hash = document.location.hash;
var prefix = "tab_";
if (hash) {
    $('.nav-tabs a[href='+hash.replace(prefix,"")+']').tab('show');
} 
// Change hash for page-reload
$('.nav-tabs a').on('shown', function (e) {
    window.location.hash = e.target.hash.replace("#", "#" + prefix);
});
</script>

{% endblock %}